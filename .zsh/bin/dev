preview_with_glow() {
  local glow_opts="$(ghq root)/{}/README.md"

  # https://github.com/charmbracelet/glow/issues/654
  echo "CLICOLOR_FORCE=1 COLORTERM=truecolor glow -p -s dark $glow_opts"
}

slugify() {
  echo $(sed "s/\./_/g" <<< $1)
}

main() {
  local active_project=$(
    ghq list | fzf \
      --tmux 80% \
      --style full \
      --list-label "Repositories" \
      --preview-label "README.md" \
      --input-label "Keyword" \
      --preview "$(preview_with_glow)"
  )

  if [ -n "$active_project" ]; then
    local session_list=$(tmux list-sessions -F "#{session_name}")
    local session_name=$(slugify "$active_project")

    if ! echo $session_list | grep -x "$session_name"; then
      tmux new-session -ds "$session_name" -c "$(ghq root)/${active_project}"
    fi

    tmux switch-client -t "$session_name"
    # zle accept-line
  fi

  # zle reset-prompt
}

main

